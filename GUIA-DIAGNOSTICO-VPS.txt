===============================================
GUÃA DE DIAGNÃ“STICO - ERROR 401 EN PRODUCCIÃ“N
===============================================

Ya subiste los archivos e hiciste build, pero sigues con el error 401.
AquÃ­ estÃ¡ cÃ³mo diagnosticar el problema paso a paso:

PASO 1: VERIFICAR QUE EL BACKEND TENGA LOS CAMBIOS
===================================================

ConÃ©ctate al VPS por SSH y ejecuta:

cd /ruta/al/backend
cat middleware/auth.js | grep "ğŸ” \[AUTH\]"

Si ves las lÃ­neas con los emojis ğŸ”, significa que el cÃ³digo nuevo estÃ¡ en el servidor.
Si NO las ves, necesitas subir los cambios nuevamente.


PASO 2: VERIFICAR EL ARCHIVO .ENV DEL BACKEND
==============================================

En el VPS, ejecuta:

cd /ruta/al/backend
cat .env

Verifica que tenga:
âœ“ CORS_ORIGINS=http://138.97.200.88:8084,http://138.97.200.88:3004,http://138.97.200.88
  (TODO EN UNA SOLA LÃNEA, sin saltos)
âœ“ JWT_SECRET=tu_secreto_secreto
âœ“ NODE_ENV=production


PASO 3: REINICIAR EL BACKEND
=============================

DespuÃ©s de verificar el .env, DEBES reiniciar el backend:

# Si usas PM2:
pm2 restart backend
pm2 logs backend --lines 50

# Si usas Docker:
docker-compose restart backend
docker logs -f <nombre_contenedor_backend>

# Si usas systemd:
sudo systemctl restart backend
sudo journalctl -u backend -f


PASO 4: VERIFICAR LOS LOGS EN TIEMPO REAL
==========================================

Mientras los logs estÃ¡n corriendo, abre el navegador y:

1. Abre DevTools (F12)
2. Ve a la pestaÃ±a Network
3. Intenta acceder a http://138.97.200.88:8084 (o donde estÃ© tu frontend)
4. Inicia sesiÃ³n
5. Intenta acceder a /api/reportes/finanzas

En los logs del backend DEBERÃAS VER:

âœ… CASO EXITOSO:
ğŸ” [AUTH] Verificando autenticaciÃ³n para: GET /api/reportes/finanzas
ğŸ” [AUTH] Headers recibidos: { authorization: 'Presente', origin: '...', referer: '...' }
âœ… [AUTH] Token encontrado, verificando...
âœ… [AUTH] Token verificado correctamente
âœ… [AUTH] Usuario autenticado correctamente

âŒ CASO DE ERROR - Token no enviado:
ğŸ” [AUTH] Verificando autenticaciÃ³n para: GET /api/reportes/finanzas
ğŸ” [AUTH] Headers recibidos: { authorization: 'Ausente', origin: '...', referer: '...' }
âŒ [AUTH] No se encontrÃ³ token en el header Authorization

âŒ CASO DE ERROR - Token expirado:
ğŸ” [AUTH] Verificando autenticaciÃ³n para: GET /api/reportes/finanzas
âœ… [AUTH] Token encontrado, verificando...
âŒ [AUTH] Error en autenticaciÃ³n: { name: 'TokenExpiredError', message: 'jwt expired' }


PASO 5: VERIFICAR EL FRONTEND
==============================

En el navegador, con DevTools abierto (F12):

A) Verificar que el token estÃ© guardado:
   - Application â†’ Local Storage â†’ http://138.97.200.88:8084
   - Buscar la key "token"
   - Si NO existe, el usuario debe volver a loguearse

B) Verificar que el token se envÃ­e en las peticiones:
   - Network â†’ Click en la peticiÃ³n a /api/reportes/finanzas
   - Headers â†’ Request Headers
   - Buscar: Authorization: Bearer eyJhbGc...
   - Si NO existe, el frontend no estÃ¡ enviando el token

C) Verificar la URL de la API:
   - Console â†’ Ejecutar: localStorage.getItem('token')
   - Si es null, cerrar sesiÃ³n y volver a loguearse


PASO 6: VERIFICAR CONFIGURACIÃ“N DEL FRONTEND
=============================================

En el VPS, verifica el .env del frontend:

cd /ruta/al/frontend
cat .env

Debe tener:
VITE_API_URL=http://138.97.200.88:3004/api

Si lo cambiaste, DEBES reconstruir el frontend:

npm run build
pm2 restart frontend
# O con docker:
docker-compose restart frontend


PASO 7: SOLUCIONES SEGÃšN EL ERROR
==================================

ERROR: "Token no encontrado"
â†’ El frontend no estÃ¡ enviando el token
â†’ SoluciÃ³n: Cerrar sesiÃ³n y volver a loguearse

ERROR: "Token expirado"
â†’ El token tiene mÃ¡s de 24 horas
â†’ SoluciÃ³n: Cerrar sesiÃ³n y volver a loguearse

ERROR: "Token invÃ¡lido"
â†’ El JWT_SECRET del backend cambiÃ³ despuÃ©s de crear el token
â†’ SoluciÃ³n: Todos los usuarios deben volver a loguearse

ERROR: "CORS bloqueado"
â†’ El origen del frontend no estÃ¡ en CORS_ORIGINS
â†’ SoluciÃ³n: Agregar http://138.97.200.88:8084 a CORS_ORIGINS y reiniciar backend

ERROR: No aparecen logs con ğŸ”
â†’ El cÃ³digo nuevo no estÃ¡ en el servidor
â†’ SoluciÃ³n: Hacer git pull y reiniciar el backend


COMANDOS ÃšTILES PARA COPIAR Y PEGAR
====================================

# Ver logs del backend en tiempo real
pm2 logs backend --lines 100

# Ver todas las variables de entorno
cd /ruta/al/backend && cat .env

# Reiniciar todo
pm2 restart all

# Ver quÃ© procesos estÃ¡n corriendo
pm2 list

# Ver logs de errores especÃ­ficamente
pm2 logs backend --err --lines 50

# Verificar que el puerto 3004 estÃ© escuchando
netstat -tlnp | grep 3004
# O
lsof -i :3004


Â¿QUÃ‰ INFORMACIÃ“N NECESITO DE TI?
=================================

Para ayudarte mejor, necesito que me digas:

1. Â¿QuÃ© ves en los logs del backend cuando intentas acceder?
   (Copia y pega las lÃ­neas que empiezan con ğŸ” o âŒ)

2. Â¿El token existe en localStorage del navegador?
   (F12 â†’ Application â†’ Local Storage)

3. Â¿El token se envÃ­a en el header Authorization?
   (F12 â†’ Network â†’ Click en la peticiÃ³n â†’ Headers)

4. Â¿Reiniciaste el backend despuÃ©s de cambiar el .env?

Con esta informaciÃ³n podrÃ© decirte exactamente quÃ© estÃ¡ fallando.
